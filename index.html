<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="translations.js"></script>
    <title id="metaTitle">Health Analyzer ABU - Аналіз язика</title>
    <meta name="description" id="metaDescription" content="">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; color: #111827; line-height: 1.6; background-color: #fff; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { padding: 16px 0; background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(243,244,246,0.8); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #111827; transition: transform 0.2s; }
        .logo:hover { transform: translateY(-1px); }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 22px; box-shadow: 0 2px 8px rgba(59,130,246,0.2); }
        .logo-text { font-size: 18px; font-weight: 700; color: #111827; }
        .logo-subtext { font-size: 11px; color: #6B7280; font-weight: 400; }
        nav { display: flex; gap: 36px; align-items: center; }
        nav a { text-decoration: none; color: #6B7280; font-size: 15px; font-weight: 500; transition: all 0.2s; position: relative; }
        nav a::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: #3B82F6; transition: width 0.3s; }
        nav a:hover { color: #111827; }
        nav a:hover::after { width: 100%; }
        .mobile-menu { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #111827; }
        .lang-btn { font-weight:600;padding:6px 14px;border-radius:8px;border:none;cursor:pointer;background:#fff;transition:background 0.2s; }
        .lang-btn.active { background: #e0e7ff; }
        .hero { padding: 80px 0 100px; text-align: center; background: linear-gradient(180deg, #fff 0%, #F9FAFB 100%); position: relative; }
        .hero::before { content: ''; position: absolute; top: 0; left: -50%; right: -50%; height: 100%; background: radial-gradient(ellipse at center top, rgba(59,130,246,0.05) 0%, transparent 70%); pointer-events: none; }
        h1 { font-size: 64px; font-weight: 900; margin-bottom: 24px; color: #111827; letter-spacing: -0.03em; line-height: 1.1; background: linear-gradient(135deg, #111827 0%, #374151 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .hero-description { font-size: 19px; color: #6B7280; max-width: 640px; margin: 0 auto 56px; line-height: 1.7; }
        .upload-section { background: #fff; border: 2px dashed #E5E7EB; border-radius: 24px; padding: 56px 48px; max-width: 520px; margin: 0 auto; text-align: center; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.04); position: relative; overflow: hidden; }
        .upload-section::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(59,130,246,0.03), transparent); transform: rotate(45deg); transition: all 0.5s; opacity: 0; }
        .upload-section:hover { border-color: #CBD5E1; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .upload-section:hover::before { opacity: 1; }
        .upload-icon { width: 64px; height: 64px; margin: 0 auto 20px; background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .upload-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #111827; }
        .upload-subtitle { color: #6B7280; font-size: 15px; margin-bottom: 32px; line-height: 1.5; }
        .button-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; border: none; font-family: inherit; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; transform: translate(-50%, -50%); transition: all 0.5s; }
        .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
        .btn-primary::before { background: rgba(255,255,255,0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59,130,246,0.4); }
        .btn-primary:hover::before { width: 300px; height: 300px; }
        .btn-secondary { background: #fff; color: #374151; border: 1.5px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-secondary:hover { background: #F9FAFB; border-color: #CBD5E1; transform: translateY(-1px); }
        .icon-camera, .icon-ai, .icon-insights { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .icon-camera svg, .icon-ai svg, .icon-insights svg { width: 32px; height: 32px; }
        .how-it-works { padding: 100px 0; background: #FAFAFA; position: relative; }
        .section-title { font-size: 42px; font-weight: 800; text-align: center; margin-bottom: 20px; color: #111827; letter-spacing: -0.02em; }
        .section-subtitle { text-align: center; color: #6B7280; font-size: 18px; margin-bottom: 64px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6; }
        .steps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 48px; max-width: 1080px; margin: 0 auto; }
        .step { text-align: center; padding: 0 16px; position: relative; }
        .step::after { content: ''; position: absolute; top: 36px; left: calc(100% - 24px); width: calc(100% - 48px); height: 2px; background: linear-gradient(90deg, #E5E7EB 0%, #E5E7EB 50%, transparent 50%); background-size: 8px 2px; }
        .step:last-child::after { display: none; }
        .step-icon { width: 80px; height: 80px; margin: 0 auto 24px; border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 4px 16px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .step:hover .step-icon { transform: translateY(-4px); }
        .step-icon.camera { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); }
        .step-icon.ai { background: linear-gradient(135deg, #E9D5FF 0%, #DDD6FE 100%); }
        .step-icon.insights { background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); }
        .step-number { position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: #111827; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
        .step-title { font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #111827; }
        .step-description { color: #6B7280; font-size: 15px; line-height: 1.6; max-width: 280px; margin: 0 auto; }
        footer { background: #0F172A; color: white; padding: 64px 0 24px; position: relative; overflow: hidden; }
        footer::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, #3B82F6, transparent); }
        .footer-content { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 64px; margin-bottom: 48px; }
        .footer-brand { max-width: 360px; }
        .footer-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .footer-logo .logo-icon { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); width: 42px; height: 42px; font-size: 20px; }
        .footer-logo .logo-text { color: white; font-size: 18px; font-weight: 700; }
        .footer-description { color: #94A3B8; font-size: 14px; line-height: 1.8; margin-bottom: 28px; }
        .social-links { display: flex; gap: 12px; }
        .social-links a { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #94A3B8; text-decoration: none; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .social-links a:hover { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: white; transform: translateY(-2px); }
        .footer-column h4 { font-size: 14px; margin-bottom: 20px; font-weight: 700; color: #F1F5F9; text-transform: uppercase; letter-spacing: 0.05em; }
        .footer-column ul { list-style: none; }
        .footer-column li { margin-bottom: 12px; }
        .footer-column a { color: #94A3B8; text-decoration: none; font-size: 14px; transition: all 0.2s; display: inline-block; }
        .footer-column a:hover { color: #F1F5F9; transform: translateX(2px); }
        .footer-bottom { text-align: center; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1); color: #64748B; font-size: 13px; }
        @media (max-width: 768px) { .mobile-menu { display: block; } nav { display: none; } h1 { font-size: 36px; line-height: 1.2; } .hero { padding: 60px 0 80px; } .hero-description { font-size: 16px; padding: 0 20px; } .upload-section { padding: 40px 24px; margin: 0 16px; } .button-group { flex-direction: column; width: 100%; } .btn { width: 100%; justify-content: center; } .footer-content { grid-template-columns: 1fr; gap: 48px; text-align: center; } .footer-brand { max-width: 100%; } .footer-logo { justify-content: center; } .social-links { justify-content: center; } .steps { grid-template-columns: 1fr; gap: 56px; } .step::after { display: none; } .section-title { font-size: 32px; } .section-subtitle { font-size: 16px; padding: 0 20px; } .upload-icon { width: 56px; height: 56px; } .how-it-works { padding: 80px 0; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.4); } 70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); } 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); } }
        .btn-primary:active { animation: pulse 0.5s; }
        html { scroll-behavior: smooth; }
        *:focus { outline: 2px solid #3B82F6; outline-offset: 2px; }
        .btn:focus { outline-offset: 4px; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">H</div>
                    <div>
                        <div class="logo-text">Health Analyzer ABU</div>
                        <div class="logo-subtext">Аналіз здоров'я</div>
                    </div>
                </a>
                <nav>
                    <a href="#how-it-works">Як це працює</a>
                    <a href="#privacy">Конфіденційність</a>
                    <a href="#support">Підтримка</a>
                </nav>
                <button class="mobile-menu" aria-label="Menu">☰</button>
                <div id="langSwitcher" style="display:flex;gap:8px;align-items:center;">
                    <button id="langUA" class="lang-btn">🇺🇦 UA</button>
                    <span style="font-size:1.1em;color:#888;">|</span>
                    <button id="langRU" class="lang-btn">🇷🇺 RU</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1 id="headerTitle">Аналіз язика</h1>
            <p class="hero-description" id="headerSubtitle">Отримайте миттєву інформацію про стан здоров'я за допомогою сучасного аналізу язика. Завантажте фото та отримайте детальну інформацію за кілька секунд.</p>

            <!-- Upload Section (сохраняем id для JS) -->
            <div class="upload-section">
                <div class="upload-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </div>
                <h2 class="upload-title" id="uploadText">Завантажте фото язика</h2>
                <p class="upload-subtitle" id="uploadHint">Зробіть чітке фото язика або завантажте з галереї</p>
                <div class="button-group">
                    <button class="btn btn-primary" id="cameraBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                        <span id="cameraBtnText">Зробити фото</span>
                    </button>
                    <button class="btn btn-secondary" id="uploadArea">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span>Завантажити файл</span>
                        <input type="file" id="fileInput" class="file-input" accept="image/*" style="display:none;">
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Camera Interface (скрыто, id сохраняем) -->
    <div id="cameraInterface" class="camera-interface" style="display:none;">
        <!-- ... (оставьте вашу камеру с id, canvas, controls) ... -->
    </div>
    <div id="photoPreview" class="photo-preview" style="display:none;">
        <!-- ... (оставьте вашу превью-фото с id) ... -->
    </div>
    <section class="preview-section" id="previewSection" style="display:none;">
        <!-- ... (оставьте вашу превью-секцию с id) ... -->
    </section>
    <div class="message" id="errorMessage"></div>
    <div class="message" id="successMessage"></div>
    <section class="results-section" id="resultsSection" style="display:none;">
        <div class="results-header">
            <h2 id="resultsHeader">Результати аналізу</h2>
        </div>
        <div id="analysisResults"></div>
        <div class="disclaimer" id="disclaimerBlock">
            <p id="disclaimerText">⚠️ Це wellness-аналіз, не замінює медичну консультацію. При серйозних симптомах зверніться до лікаря.</p>
        </div>
    </section>
    <div id="globalProgress" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
        <div class="spinner" style="margin-bottom:20px;width:60px;height:60px;border:8px solid #eee;border-top:8px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <div id="progressText" style="font-size:1.2rem;color:#333;margin-bottom:10px;"></div>
        <div id="progressBarContainer" style="width:240px;height:12px;background:#eee;border-radius:8px;overflow:hidden;display:none;">
            <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);"></div>
        </div>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <!-- How it Works -->
    <section class="how-it-works" id="how-it-works">
        <div class="container">
            <h2 class="section-title">Як це працює</h2>
            <p class="section-subtitle">Наша технологія аналізує характеристики язика для надання інформації про здоров'я за три простих кроки</p>
            <div class="steps">
                <div class="step">
                    <div class="step-icon camera"><span class="step-number">1</span><div class="icon-camera"><svg viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div></div>
                    <h3 class="step-title">Зробіть фото</h3>
                    <p class="step-description">Зробіть чітке фото язика за допомогою нашого інтерфейсу камери або завантажте з пристрою</p>
                </div>
                <div class="step">
                    <div class="step-icon ai"><span class="step-number">2</span><div class="icon-ai"><svg viewBox="0 0 24 24" fill="none" stroke="#9333EA" stroke-width="2"><path d="M12 2L2 7L12 12L22 7L12 2Z"/><path d="M2 17L12 22L22 17"/><path d="M2 12L12 17L22 12"/></svg></div></div>
                    <h3 class="step-title">Аналіз</h3>
                    <p class="step-description">Наша технологія обробляє зображення, аналізуючи колір, текстуру, наліт та інші показники здоров'я</p>
                </div>
                <div class="step">
                    <div class="step-icon insights"><span class="step-number">3</span><div class="icon-insights"><svg viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div></div>
                    <h3 class="step-title">Отримайте результати</h3>
                    <p class="step-description">Отримайте детальну інформацію про стан здоров'я, рекомендації та комплексний звіт з аналізом</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo"><div class="logo-icon">H</div><div class="logo-text">Health Analyzer ABU</div></div>
                    <p class="footer-description">Розширений аналіз здоров'я через обстеження язика. Отримайте миттєві рекомендації для вашого здоров'я за допомогою передових технологій.</p>
                    <div class="social-links">
                        <a href="#" aria-label="TikTok"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></a>
                        <a href="#" aria-label="Instagram"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg></a>
                        <a href="#" aria-label="Telegram"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.56c-.21 2.27-1.13 7.75-1.6 10.29-.2 1.08-.58 1.44-.95 1.47-.81.07-1.43-.53-2.22-1.04-1.23-.81-1.93-1.31-3.12-2.1-1.38-.91-.49-1.41.3-2.23.21-.21 3.82-3.5 3.89-3.8.01-.04.02-.18-.07-.26s-.21-.05-.3-.03c-.13.02-2.16 1.38-6.11 4.04-.58.4-1.1.59-1.57.58-.52-.01-1.51-.29-2.25-.53-.91-.3-1.63-.45-1.57-.96.03-.26.4-.53 1.1-.8 4.32-1.88 7.2-3.12 8.65-3.72 4.12-1.7 4.98-2 5.54-2.01.12 0 .4.03.58.17.15.12.19.28.21.44-.01.08.01.24-.01.37z"/></svg></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h4>Продукт</h4>
                    <ul>
                        <li><a href="#">Як це працює</a></li>
                        <li><a href="#">Точність</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Підтримка</h4>
                    <ul>
                        <li><a href="#">Політика конфіденційності</a></li>
                        <li><a href="#">Умови використання</a></li>
                        <li><a href="#">Зв'язатися з нами</a></li>
                        <li><a href="#">Центр допомоги</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2024 Health Analyzer ABU. Усі права захищено. Цей інструмент призначений лише для інформаційних цілей.</p>
            </div>
        </div>
    </footer>
    <script>
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const detailedAnalysisBtn = document.getElementById('detailedAnalysisBtn');
        const comprehensiveAnalysisBtn = document.getElementById('comprehensiveAnalysisBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const resultsSection = document.getElementById('resultsSection');
        const analysisResults = document.getElementById('analysisResults');

        // State variables
        let currentImageFile = null;
        let uploadedImageUrl = null;
        let currentAnalysisId = null;

        // Camera variables
        let currentStream = null;
        let currentFacingMode = 'user'; // 'user' for front camera, 'environment' for back
        let capturedImageBlob = null;

        // --- PROGRESS INDICATOR UTILS ---
        function showGlobalProgress(text, percent = null) {
            const el = document.getElementById('globalProgress');
            const txt = document.getElementById('progressText');
            const bar = document.getElementById('progressBar');
            const barCont = document.getElementById('progressBarContainer');
            el.style.display = 'flex';
            txt.textContent = text || '';
            if (percent !== null) {
                barCont.style.display = 'block';
                bar.style.width = Math.max(0, Math.min(100, percent)) + '%';
            } else {
                barCont.style.display = 'none';
                bar.style.width = '0%';
            }
        }
        function hideGlobalProgress() {
            document.getElementById('globalProgress').style.display = 'none';
        }
        // --- END PROGRESS UTILS ---

        // Функция для добавления цветовых акцентов и эмодзи
        function enhanceTextWithAccents(text) {
            return text
                // Добавляем зеленые акценты для положительных характеристик
                .replace(/(нормальн|здоров|правильн|естественн|хорош)/gi, '<span class="highlight-green">🟢 $1</span>')
                // Добавляем желтые акценты для внимания
                .replace(/(повышенн|увеличенн|выраженн|заметн)/gi, '<span class="highlight-yellow">🟡 $1</span>')
                // Добавляем красные акценты для отклонений
                .replace(/(патологическ|воспалительн|аномальн|нарушен)/gi, '<span class="highlight-red">🔴 $1</span>')
                // Добавляем синие акценты для технических терминов
                .replace(/(морфологическ|структурн|анатомическ|топографическ)/gi, '<span class="highlight-blue">$1</span>')
                // Добавляем эмодзи для ключевых элементов
                .replace(/цвет|пигмент/gi, '🎨 $&')
                .replace(/поверхность|текстура/gi, '🔬 $&')
                .replace(/сосочки|борозды/gi, '📐 $&');
        }

        // Generate unique analysis ID
        function generateAnalysisId() {
            return `analysis_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        }

        // Show/hide messages
        function showError(messageKey) {
            errorMessage.textContent = t(messageKey) || messageKey;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
        }

        function showSuccess(messageKey) {
            successMessage.textContent = t(messageKey) || messageKey;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
        }

        function clearResults() {
            resultsSection.style.display = 'none';
            analysisResults.innerHTML = '';
        }

        // File handling
        function handleFileSelect(file) {
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showError('error_invalid_file_type');
                return;
            }

            // Validate file size
            if (file.size > 10 * 1024 * 1024) {
                showError('error_file_too_large');
                return;
            }

            currentImageFile = file;
            currentAnalysisId = generateAnalysisId();
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewSection.style.display = 'block';
                clearResults();
            };
            reader.readAsDataURL(file);

            console.log('File selected:', {
                name: file.name,
                size: file.size,
                type: file.type,
                analysisId: currentAnalysisId
            });
        }

        // Upload file to Cloudinary (with progress)
        async function uploadFile(file) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const formData = new FormData();
                formData.append('image', file);
                xhr.open('POST', '/.netlify/functions/upload');
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        showGlobalProgress(t('loading_upload'), percent);
                    }
                };
                xhr.onload = function() {
                    hideGlobalProgress();
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch (err) {
                            reject(new Error('Ошибка разбора ответа сервера'));
                        }
                    } else {
                        let errMsg = t('error_upload_failed');
                        try {
                            errMsg = JSON.parse(xhr.responseText).error || errMsg;
                        } catch {}
                        reject(new Error(errMsg));
                    }
                };
                xhr.onerror = function() {
                    hideGlobalProgress();
                    reject(new Error('Ошибка сети при загрузке файла'));
                };
                showGlobalProgress(t('loading_upload'), 0);
                xhr.send(formData);
            });
        }

        // Detailed analysis
        async function analyzeImageDetailed(imageUrl, analysisId) {
            const response = await fetch('/.netlify/functions/analyze-detailed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({
                    imageUrl,
                    analysisId,
                    timestamp: Date.now(),
                    language: currentLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || t('error_detailed_analysis_failed'));
            }

            return await response.json();
        }

        // Comprehensive analysis
        async function analyzeImageComprehensive(imageUrl, analysisId, detailedAnalysis = null) {
            const response = await fetch('/.netlify/functions/analyze-comprehensive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                body: JSON.stringify({
                    imageUrl,
                    analysisId,
                    timestamp: Date.now(),
                    detailedAnalysis,
                    language: currentLang
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || t('error_comprehensive_analysis_failed'));
            }

            return await response.json();
        }

        // Display detailed results
        function displayDetailedResults(analysisData) {
            let resultsHTML = `
                <div class="analysis-card fade-in">
                    <h3>�� Комплексний візуальний аналіз</h3>
            `;

            // Общая характеристика с разделением на строки
            if (analysisData.detailed_analysis) {
                let formattedAnalysis = analysisData.detailed_analysis;
                
                // Разбиваем текст на предложения и форматируем как список
                formattedAnalysis = formattedAnalysis
                    .split('. ')
                    .filter(sentence => sentence.trim().length > 10)
                    .map(sentence => sentence.trim() + (sentence.endsWith('.') ? '' : '.'))
                    .join('\n\n');

                resultsHTML += `
                    <div class="mini-card">
                        <h4><span class="section-icon">📋</span>Загальна характеристика:</h4>
                        <p style="white-space: pre-line;">${enhanceTextWithAccents(formattedAnalysis)}</p>
                    </div>
                `;
            }

            // Визуальные находки с разделением на строки
            if (analysisData.visual_findings) {
                let formattedFindings = analysisData.visual_findings;
                
                // Разбиваем текст на предложения и форматируем как список
                formattedFindings = formattedFindings
                    .split('. ')
                    .filter(sentence => sentence.trim().length > 10)
                    .map(sentence => sentence.trim() + (sentence.endsWith('.') ? '' : '.'))
                    .join('\n\n');

                resultsHTML += `
                    <div class="mini-card">
                        <h4><span class="section-icon">🔍</span>Ключові знахідки:</h4>
                        <p style="white-space: pre-line;">${enhanceTextWithAccents(formattedFindings)}</p>
                    </div>
                `;
            }

            // Морфологические особенности
            if (analysisData.morphological_features) {
                // Форматируем морфологические особенности в список
                let formattedFeatures = analysisData.morphological_features;
                
                // Убираем дублирующий заголовок из текста если он есть
                formattedFeatures = formattedFeatures.replace(/^⚙️\s*Морфологічні особливості:\s*/i, '');
                formattedFeatures = formattedFeatures.replace(/^Морфологічні особливості:\s*/i, '');
                
                // Если текст содержит " - " (дефис с пробелами), разбиваем на пункты
                if (formattedFeatures.includes(' - ')) {
                    formattedFeatures = formattedFeatures
                        .split(' - ')
                        .map((item, index) => {
                            if (index === 0) {
                                // Первый элемент может содержать заголовок
                                return item.trim();
                            } else {
                                // Остальные элементы форматируем как пункты списка
                                return `- ${item.trim()}`;
                            }
                        })
                        .join('\n\n');
                }
                
                resultsHTML += `
                    <div class="mini-card">
                        <h4><span class="section-icon">⚙️</span>Морфологічні особливості:</h4>
                        <p style="white-space: pre-line;">${enhanceTextWithAccents(formattedFeatures)}</p>
                    </div>
                `;
            }

            resultsHTML += `</div>`;

            analysisResults.innerHTML = resultsHTML;
            resultsSection.style.display = 'block';
            setTimeout(() => {
                resultsSection.classList.add('fade-in');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 50);
        }

        // Display comprehensive results
        function displayComprehensiveResults(analysisData) {
            let resultsHTML = '';

            if (analysisData.zone_analysis) {
                resultsHTML += `
                    <div class="analysis-card fade-in">
                        <h3>🗺️ Зональний аналіз</h3>
                        <div class="zone-grid">
                            <div class="zone-card">
                                <h4>Передня зона (Серце/Легкі)</h4>
                                <p>${analysisData.zone_analysis.anterior || 'Не вказано'}</p>
                            </div>
                            <div class="zone-card">
                                <h4>Середня зона (Шлунково-кишковий тракт)</h4>
                                <p>${analysisData.zone_analysis.middle || 'Не вказано'}</p>
                            </div>
                            <div class="zone-card">
                                <h4>Задня зона (Нирки)</h4>
                                <p>${analysisData.zone_analysis.posterior || 'Не вказано'}</p>
                            </div>
                            <div class="zone-card">
                                <h4>Бічні зони (Печінка)</h4>
                                <p>${analysisData.zone_analysis.lateral || 'Не вказано'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Объединенный блок wellness оценки (ЗАДАЧА 2)
            if (analysisData.health_interpretation || analysisData.overall_health_score) {
                resultsHTML += `
                    <div class="analysis-card fade-in">
                        <h3>🏥 Оцінка Wellness</h3>
                `;
                
                if (analysisData.health_interpretation) {
                    resultsHTML += `<p>${analysisData.health_interpretation}</p>`;
                }
                
                if (analysisData.overall_health_score) {
                    resultsHTML += `<p><strong>Загальна оцінка:</strong> ${analysisData.overall_health_score}</p>`;
                }
                
                resultsHTML += `</div>`;
            }

            // Объединенный блок рекомендаций (ЗАДАЧА 3)
            if (analysisData.wellness_recommendations || analysisData.lifestyle_advice) {
                resultsHTML += `
                    <div class="analysis-card fade-in">
                        <h3>🌱 Персональні рекомендації</h3>
                `;
                
                if (analysisData.wellness_recommendations) {
                    resultsHTML += `
                        <div class="recommendation-section">
                            <h4>Рекомендовані продукти</h4>
                            <p>${analysisData.wellness_recommendations}</p>
                        </div>
                    `;
                }
                
                if (analysisData.lifestyle_advice) {
                    resultsHTML += `
                        <div class="recommendation-section">
                            <h4>Стан життя</h4>
                            <p>${analysisData.lifestyle_advice}</p>
                        </div>
                    `;
                }
                
                resultsHTML += `</div>`;
            }

            analysisResults.innerHTML = resultsHTML;
            resultsSection.style.display = 'block';
            setTimeout(() => {
                resultsSection.classList.add('fade-in');
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }, 50);
        }

        // Camera functionality
        async function startCamera(facingMode = 'user') {
            try {
                console.log('Starting camera with facingMode:', facingMode);
                
                // Stop existing stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Check if camera is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not supported');
                }

                // Try simpler constraints first
                let constraints = {
                    video: true
                };

                // If we have preference for camera, try to use it
                if (facingMode) {
                    constraints = {
                        video: {
                            facingMode: facingMode
                        }
                    };
                }

                console.log('Requesting camera with constraints:', constraints);
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = document.getElementById('cameraVideo');
                console.log('Video element found:', videoElement);
                
                videoElement.srcObject = currentStream;
                currentFacingMode = facingMode;

                // Применяем правильное зеркалирование в зависимости от камеры
                if (facingMode === 'user') {
                    videoElement.className = 'front-camera';
                    console.log('Applied front camera mirroring');
                } else {
                    videoElement.className = 'back-camera';
                    console.log('Applied back camera normal view');
                }

                // Wait for video to load
                return new Promise((resolve, reject) => {
                    videoElement.onloadedmetadata = () => {
                        console.log('Video metadata loaded, playing...');
                        videoElement.play().then(() => {
                            console.log('Camera started successfully:', facingMode);
                            resolve(true);
                        }).catch(error => {
                            console.error('Error playing video:', error);
                            reject(error);
                        });
                    };
                    
                    videoElement.onerror = (error) => {
                        console.error('Video element error:', error);
                        reject(error);
                    };
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (videoElement.readyState === 0) {
                            reject(new Error('Video load timeout'));
                        }
                    }, 10000);
                });

            } catch (error) {
                console.error('Error starting camera:', error);
                
                // Fallback: try different camera
                if (facingMode === 'user') {
                    try {
                        console.log('Trying fallback to environment camera');
                        return await startCamera('environment');
                    } catch (fallbackError) {
                        console.error('Fallback camera also failed:', fallbackError);
                        showError('error_camera_access_denied');
                        return false;
                    }
                } else {
                    showError('error_camera_unavailable');
                    return false;
                }
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Для фронтальной камеры нужно отразить изображение обратно при сохранении
            if (currentFacingMode === 'user') {
                // Отражаем изображение горизонтально для правильного сохранения
                context.scale(-1, 1);
                context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
                console.log('Captured front camera photo with correction');
            } else {
                // Для задней камеры сохраняем как есть
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                console.log('Captured back camera photo normally');
            }

            // Convert to blob
            canvas.toBlob((blob) => {
                if (blob) {
                    capturedImageBlob = blob;
                    
                    // Show preview
                    const previewImg = document.getElementById('previewImg');
                    const objectURL = URL.createObjectURL(blob);
                    previewImg.src = objectURL;
                    
                    // Hide camera, show preview
                    document.getElementById('cameraInterface').style.display = 'none';
                    document.getElementById('photoPreview').style.display = 'flex';
                } else {
                    showError('error_photo_capture_failed');
                }
            }, 'image/jpeg', 0.9);
        }

        async function switchCamera() {
            const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            // Показываем индикатор переключения
            const hintElement = document.querySelector('.camera-hint');
            const originalHint = hintElement.textContent;
            hintElement.textContent = t('camera_switching');
            
            try {
                await startCamera(newFacingMode);
                hintElement.textContent = originalHint;
                console.log('Camera switched to:', newFacingMode);
            } catch (error) {
                console.error('Failed to switch camera:', error);
                hintElement.textContent = originalHint;
                showError('error_camera_switch_failed');
            }
        }

        function usePhoto() {
            if (capturedImageBlob) {
                // Create file from blob
                const file = new File([capturedImageBlob], 'camera_photo.jpg', {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });

                handleFileSelect(file);
                
                // Hide preview
                document.getElementById('photoPreview').style.display = 'none';
                stopCamera();
            }
        }

        function retakePhoto() {
            // Hide preview, show camera
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('cameraInterface').style.display = 'flex';
        }

        // Camera event listeners
        document.getElementById('cameraBtn').addEventListener('click', async () => {
            console.log('Camera button clicked');
            const cameraInterface = document.getElementById('cameraInterface');
            
            // Show loading state
            cameraInterface.style.display = 'flex';
            const hintElement = document.querySelector('.camera-hint');
            const originalHint = hintElement.textContent;
            hintElement.textContent = t('camera_starting');
            
            try {
                const success = await startCamera('user'); // Start with front camera
                if (success) {
                    hintElement.textContent = originalHint;
                } else {
                    cameraInterface.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to start camera:', error);
                cameraInterface.style.display = 'none';
                hintElement.textContent = originalHint;
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('cameraInterface').style.display = 'none';
            stopCamera();
        });

        document.getElementById('captureBtn').addEventListener('click', capturePhoto);
        document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
        document.getElementById('usePhotoBtn').addEventListener('click', usePhoto);
        document.getElementById('retakeBtn').addEventListener('click', retakePhoto);

        // Touch events for mobile
        document.getElementById('cameraVideo').addEventListener('click', () => {
            // Auto-focus on touch (if supported)
            if (currentStream) {
                const videoTrack = currentStream.getVideoTracks()[0];
                if (videoTrack && videoTrack.getSettings) {
                    // Focus functionality for supported devices
                    console.log('Video tap detected');
                }
            }
        });

        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Detailed analysis button
        detailedAnalysisBtn.addEventListener('click', async () => {
            if (!currentImageFile) {
                showError('error_no_image_for_analysis');
                return;
            }

            const analysisId = currentAnalysisId;
            const btn = detailedAnalysisBtn;
            const spinner = document.getElementById('detailedSpinner');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            clearResults();

            try {
                showSuccess('success_uploading_image');
                const uploadResult = await uploadFile(currentImageFile);
                uploadedImageUrl = uploadResult.url;

                showGlobalProgress(t('loading_analysis'), null);
                showSuccess(t('analysis_detailed_in_progress'));
                const analysisResult = await analyzeImageDetailed(uploadedImageUrl, analysisId);
                hideGlobalProgress();

                if (analysisId === currentAnalysisId) {
                    displayDetailedResults(analysisResult);
                    showSuccess(t('analysis_detailed_completed'));
                }

            } catch (error) {
                hideGlobalProgress();
                console.error('Detailed analysis error:', error);
                showError(error.message || t('error_detailed_analysis_failed'));
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        });

        // Comprehensive analysis button
        comprehensiveAnalysisBtn.addEventListener('click', async () => {
            if (!currentImageFile) {
                showError('error_no_image_for_analysis');
                return;
            }

            const analysisId = currentAnalysisId;
            const btn = comprehensiveAnalysisBtn;
            const spinner = document.getElementById('comprehensiveSpinner');
            
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            clearResults();

            try {
                showSuccess('success_uploading_image');
                const uploadResult = await uploadFile(currentImageFile);
                uploadedImageUrl = uploadResult.url;

                showGlobalProgress(t('loading_analysis'), null);
                showSuccess(t('analysis_comprehensive_in_progress'));
                const analysisResult = await analyzeImageComprehensive(uploadedImageUrl, analysisId);
                hideGlobalProgress();

                if (analysisId === currentAnalysisId) {
                    displayComprehensiveResults(analysisResult);
                    showSuccess(t('analysis_comprehensive_completed'));
                }

            } catch (error) {
                hideGlobalProgress();
                console.error('Comprehensive analysis error:', error);
                showError(error.message || t('error_comprehensive_analysis_failed'));
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        });

        console.log('Health Analyzer Pro initialized with dual analysis system');

        // --- TRANSLATION SYSTEM ---
        let currentLang = localStorage.getItem('lang') || 'ua';
        function setLang(lang) {
            if (!TRANSLATIONS[lang]) lang = 'ua';
            currentLang = lang;
            localStorage.setItem('lang', lang);
            applyTranslations();
            highlightLangBtn();
        }
        function highlightLangBtn() {
            document.getElementById('langUA').style.background = currentLang === 'ua' ? '#e0e7ff' : '#fff';
            document.getElementById('langRU').style.background = currentLang === 'ru' ? '#e0e7ff' : '#fff';
        }
        function t(key) {
            return TRANSLATIONS[currentLang][key] || TRANSLATIONS['ua'][key] || key;
        }
        function applyTranslations() {
            // Meta
            document.title = t('meta_title');
            const metaDesc = document.getElementById('metaDescription');
            if (metaDesc) metaDesc.setAttribute('content', t('meta_description'));
            // Header
            document.getElementById('headerTitle').textContent = t('header_title');
            document.getElementById('headerSubtitle').textContent = t('header_subtitle');
            // Upload
            document.getElementById('uploadText').textContent = t('upload_drag');
            document.getElementById('uploadHint').textContent = t('upload_hint');
            document.getElementById('cameraBtnText').textContent = t('camera_btn');
            // Preview
            document.getElementById('previewImage').alt = t('preview_alt');
            // Analysis buttons
            document.getElementById('detailedBtnTitle').textContent = t('analysis_detailed');
            document.getElementById('detailedBtnDesc').textContent = t('analysis_detailed_desc');
            document.getElementById('detailedBtnTime').textContent = t('analysis_time');
            document.getElementById('comprehensiveBtnTitle').textContent = t('analysis_comprehensive');
            document.getElementById('comprehensiveBtnDesc').textContent = t('analysis_comprehensive_desc');
            document.getElementById('comprehensiveBtnTime').textContent = t('analysis_time');
            // Results
            document.getElementById('resultsHeader').textContent = t('results_header');
            document.getElementById('disclaimerText').textContent = t('disclaimer');
            // Preview controls
            const previewTitle = document.querySelector('.preview-title');
            if (previewTitle) previewTitle.textContent = t('preview_title');
            const retakeBtn = document.getElementById('retakeBtn');
            if (retakeBtn) retakeBtn.textContent = t('retake_btn');
            const useBtn = document.getElementById('usePhotoBtn');
            if (useBtn) useBtn.textContent = t('use_btn');
            // Progress
            const progressText = document.getElementById('progressText');
            if (progressText && progressText.textContent.includes('Завантаження') || progressText.textContent.includes('Завантаження') || progressText.textContent.includes('Upload')) {
                progressText.textContent = t('loading_upload');
            }
            if (progressText && progressText.textContent.includes('Аналіз') || progressText.textContent.includes('Аналіз') || progressText.textContent.includes('Analysis')) {
                progressText.textContent = t('loading_analysis');
            }
        }
        document.getElementById('langUA').onclick = () => setLang('ua');
        document.getElementById('langRU').onclick = () => setLang('ru');
        // --- END TRANSLATION SYSTEM ---

        // Вызов applyTranslations() при загрузке
        applyTranslations();
        highlightLangBtn();
    </script>
</body>
</html>
